---
title: "Intro to Programming in R - 1 <br>"
subtitle: ""
author: "Bon Woo Koo"
institute: "RStudio, PBC"
date: "2016/12/12 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    self_contained: true
    seal: false
    css: ['my-theme.css']
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
class: middle, center, inverse

background-image: url("https://i2.wp.com/files.123freevectors.com/wp-content/original/110712-dark-blue-blurred-background-vector.jpg?w=2000&q=95")
background-size: cover

# Intro to Programming in R
<br><br><br><br><br><br>

<font size=4>by</font>
<br>
<font size=6> Bon Woo Koo <br> Subhro Guhathakurta </font>
<br><br>
<font size=4> Aug 25, 2022</font>

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Open Sans"),
  text_font_google   = google_font("Source Sans Pro", "400", "400i"),
  code_font_google   = google_font("Fira")
)

nice_table <- function(df, height="150px"){
  return(
    df %>% kable() %>% 
      kable_styling(latex_options="scale_down", font_size=12) %>% 
      scroll_box(width = "100%", height = height)
    )
}
```

---
```{r, include=F}
library(xaringanthemer)
library(sf)
library(tidyverse)
library(leaflet)
library(tmap)
library(kableExtra)
```


## What is R?
.mid[R is a powerful programming language for statistics, data science, etc.

You can do all kinds of statistical analyses, from the most basic ones to artificial intelligence.

Using `sf` package, you can (almost) replace GIS applications, such as QGIS or ArcMAP.

It is completely free to use.]

---
## What is R?
.mid[
R makes communicating your data and findings easy through online platforms easy.

You can also create [dashboards](https://shiny.rstudio.com/gallery/india-blood-banks.html), blog posts with interactive maps and charts.
]

![covid mobility data](https://tilburgsciencehub.com/examples/images/demo_app.png)
<br>

---
## What is R studio?
.mid[
R-Studio is a code editor developed for R. 

R is a language, just like any other language (e.g., English, French etc). You can write R code in any text editor.

e.g., you can write your English report in Notepad, but people usually use MS Word because it provides convenient functions.
]

.center[
### *R-Studio is like MS Word for R language.*
]

---
<!-- INSTALL -->
## Installation

.mid[
R language and R-Studio need to be installed separately.
]

  
.left-column[
###[Click to install R](https://cran.r-project.org/)

<br><br>

###[Click to install R-Studio](https://www.rstudio.com/products/rstudio/download/)

]

.right-column[
1.Choose your operation system (e.g., Windows, macOS, etc.). 

2.Choose base.

3.Click "Download R-4.2.1" for your OS.

4.Install using the downloaded file with all default options selected.
]




.right-column[
1.Choose **RStudio Desktop** (free version)

2.Choose your operation system and download installation file.

3.Install using the downloaded file with all default options selected.
]

---
## Using virtual machine

.mid[
However, we have set up virtual machines (VMs) specifically for this class, in which *most of the required packages and applications are pre-installed*.

Unless you've installed required packages before the class, we encourage you to use VM in class at https://mycloud.gatech.edu.
]

```{r echo=F}
knitr::include_graphics("mycloud.jpg")
```

.center[
#### Please be careful when you install something other than what this class tells you to, <br> unless you know what you are doing very well
]

---
# RStudio

```{r, include=F, out.height='30%'}
knitr::include_graphics("https://datacarpentry.org/genomics-r-intro/fig/rstudio_session_4pane_layout.png")
```


# ![](https://datacarpentry.org/genomics-r-intro/fig/rstudio_session_4pane_layout.png)

---
## Packages
.mid[
Packages are extensions to R that provide various functions and datasets that the plain R does not have. 
]

###.center[It is like apps for your phone.]

.mid[
**Step 1**: You first need to install a package into your hard drive. Just like installing apps in your phone, you only need to do it once per computer.

**Step 2**: You need to load the package into your R session. This is like opening an app in your phone.

**Step 3**: Now the package is loaded. You can use functions in the package.
]

---
class: inverse, middle, center

## Let's write some code.

---
class: inverse, middle, center

# (Very) Basics

---
## R as a calculator
I actually use R this way very often.

```{r}
(33 + 43) / 4

exp(2.3) # de-logging natural log

a <- 23 + 21
b <- pi # 3.141593...
a / b
```

---
## R is case sensitive
In R, a and A are not the same. Sounds really simple, but I've seen people pulling their hair out because they couldn't find a small typo.

For example, the following code will throw an error. Imagine you are looking for that *capital C* in a script with hundreds of lines of code.

```{r eval=F}
location <- "paris"
loCation

#> Error: object 'loCation' not found
```


---
## Indexing
We can access values in a vector (or any other data structures) through indexing. We use extract operator `[]` to specify which values we'd like to extract or replace.

```{r}
my_vec <- c(5,4,3,2,1)
my_vec[c(3,4)]
```


---
<!-- dplyr -->
## Setting Environment

.mid[
When we start writing a R script, we usually call libraries and set the working directory (WD).

In R Markdown, WD is where the RMD file is located. This usually works fine. 

For a plain R script, WD is usually somewhere like *C:/Users/Bonwoo/Documents*.
]

.mid[.center[
**We need to use different strategies depending on <br> whether you are working on a RMarkdown or a plain R script.**
]]

.pull-left[
**On Plain R script**
```{r eval=F}
setwd("path-to-your-wd")
```
]

.pull-right[
**In R Markdown**
```{r eval=F}
knitr::opts_knit$set(
  roo.dir = "path-to-your-wd")
```
]

---
## Reading data

In urban analytics for planning, the file formats we usually deal with include (but not limited to) **.CSV**, **.SHP**, **.JSON**, and **.GEOJSON**.

We need different packages to import these data formats. 

Sample data: <font size=3px color="grey"> (you can copy the link adress instead of downloading them) </font> <br>
[CSV](https://raw.githubusercontent.com/BonwooKoo/UrbanAnalytics2022/main/Lab/module_0/testdata.csv), [SHP](https://raw.githubusercontent.com/BonwooKoo/UrbanAnalytics2022/main/Lab/module_0/testdata.geojson), [JSON](https://raw.githubusercontent.com/BonwooKoo/UrbanAnalytics2022/main/Lab/module_0/testdata.json)


```{r eval=F}
# CSV files
library(tidyverse)
df <- read.csv("file-name.csv") # or
df <- readr::read_csv("file-name.csv")

# SHP & GEOJSON files
df <- sf::st_read("file-name.shp")
df <- sf::st_read("file-name.geojson")

# JSON files
df <- jsonlite::fromJSON("file-name.json") %>% 
  as.data.frame()
```

---
## Basic verbs of dplyr
Assuming tabular data (e.g., like an Excel file), there is a set of operations we routinely perform, such as filtering rows, creating new variables, etc.

Let's try some of the common used verbs.

```{r, message=F}
# Need data first...
my_df <- read_csv("https://raw.githubusercontent.com/BonwooKoo/UrbanAnalytics2022/main/Lab/module_0/testdata.csv")
my_df %>% nice_table("200px")
```

---
## dplyr basics

#### select, filter, arrange, mutate, group_by + summarise

All verbs work similarly: <font size=2px, color='grey'>(Wickham & Grolemund (2016))</font>

* The first argument of the verbs is a data frame.
* The subsequent arguments describe what to do with the data frame
* The result is a new data frame.

--

e.g., `filter()` picks observations (i.e., rows of a DF) by their values.

```{r}
filter(my_df, # specifies which data.frame
       county == "DeKalb County") %>%  # conditional statement  
  nice_table() # ignore this nice_table() for now.
```

---
## BTW, %>% is called the **pipe**.
.center[.mid[
It takes whatever is passed from **before** the pipe and 

inserts it as **the first argument** of the following function.
]]

```{r eval=F}
filter(my_df, county == "DeKalb County") %>%  
  nice_table("150px")
```

is equivalent to

```{r}
my_df %>% filter(county == "DeKalb County") %>% 
  nice_table("150px")
```

---
## Back to dplyr basics

.pull-left[
* **select()** can pick **variable(s)** by their names.

```{r}
my_df %>% 
  select(county,race.white) %>% #<<
  nice_table()
```
]

.pull-right[
* **arrange()** can reorder **rows**.
```{r}
my_df %>% 
  select(county,race.white) %>% 
  arrange(race.white) %>% #<<
  nice_table()
```

.center[
**Notice that %>% connects multiple dplyr verbs down the line.**

**This is why pipe is so useful!**
]
]

---
## dplyr basics

**mutate()** can create a new columns using existing columns.
```{r}
my_df %>% 
  mutate(pct_white = race.white / race.tot) %>% #<<
  select(2:4, race.tot, race.white, pct_white) %>% nice_table()
```

Notice that **select()** can take either variable names or the index of columns.

Because `2:4` in R is the same as `c(2,3,4)`, we select not only tot_age25, less_hs, and pct_less_hs, but also the second, third, and fourth columns **of the data table that were passed to select()**.

---
## dplyr basics
**group_by()** creates a grouping across observations (i.e., rows). With the grouping, **summarise()** can do summarization (e.g., taking average) for each group.

In plain English, this code says "Take **my_df** and calculate the mean of **pct_white** and the median of **hhincome** for each county." It returns a new data table.

```{r}
my_df %>% mutate(pct_white = race.white / race.tot) %>%
  group_by(county) %>% # creating grouping by county.  #<<
  summarise(avg.pct_white = mean(pct_white), # mean for each county
            med.hhincome = median(hhincome)) %>% nice_table("160px")
```

.mid[.center[**Notice that there are NaN and NA here and there.**]]

---
##  NAs and NaNs
NaN stands for **Not a Number.** This results from numerical operation that outputs undefined results. Try `0/0` in your console.

NA stands for **Not available.** This generally means missing value.

Let's see why this happened.

```{r}
my_df %>% select(-GEOID, -tract, -county, -state) %>% summary() 
```

.center[Notice that hhincome has 5 missing values (NAs). race.tot has at least one 0]

---
## Dropping NaN and NA
We need to filter out from both race.tot and hhincome. 

The logical *and* (&) operator for a set of boolean operands (i.e., condition) will be true if and only if all the operands are true. For logical *or* operator, R uses |. 

Also notice the exclamation mark (**!**) and **is.na()**. **!** negates logical boolean operands. For example `!TRUE` is `FALSE`. So, !is.na(hhincome) is a vector consisting of TRUEs and FALSEs where it is TRUE where hhincome has NA values.

```{r}
my_df %>% 
  filter(race.tot > 0 & !is.na(hhincome)) %>% #<<
  mutate(pct_white = race.white / race.tot) %>%
  group_by(county) %>% # creating grouping by county.  
  summarise(avg.pct_white = mean(pct_white), # mean for each county
            med.hhincome = median(hhincome)) %>% nice_table("160px")
```

---
# Reading SHP and JSON
Reading SHP and JSON files are no different, except you need some packages. Notice below that we are reading GEOJSON rather than SHP -- they are essentially the same data in different formats.

```{r include=F}
shp <- sf::st_read("https://raw.githubusercontent.com/BonwooKoo/UrbanAnalytics2022/main/Lab/module_0/testdata.geojson")
```


```{r message=FALSE, eval=F}
shp <- sf::st_read("https://raw.githubusercontent.com/BonwooKoo/UrbanAnalytics2022/main/Lab/module_0/testdata.geojson") 
js <- jsonlite::fromJSON("https://raw.githubusercontent.com/BonwooKoo/UrbanAnalytics2022/main/Lab/module_0/testdata.json", flatten = TRUE)
```
```{r}
shp %>% nice_table()
```

---
# 

```{r out.width="100%", out.height="50%"}
library(leaflet)
pal <- colorNumeric(palette = "Reds", domain = shp$hhincome)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(data = shp, fillColor = ~pal(hhincome), fillOpacity = 0.8, weight = 1, color = "white", popup = paste0("Household Income: ", shp$hhincome)) %>% 
  addLegend(position = "topright", pal = pal, values = shp$hhincome, title = "Annual Household Income", bins = 6)
```


---
# More resources

* swirl package: If you need to start from the very basic, 
```{r eval=F}
install.packages('swirl')
library(swirl)
swirl()
```

* [R for Data Science](https://r4ds.had.co.nz/): This is (I think) the best resources out there for getting started with R.